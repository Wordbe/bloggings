# Spark 8 - Structured Streaming

정형화 스트리밍

- 스트림 처리 시스템은 멀티 노드 분산 처리 엔진으로 진화
- 전통 분산 스트림 처리는 '레코드 단위 처리 모델' 로 구현
  - 응답시간 매우 짧음
  - 하지만 노드 장애시 회복하는게 쉽지 않다.

## Micro batch Stream 처리

- 스파크 스트리밍(=DStream) 등장 : 마이크로 배치 스트림 처리. 아주 작은 맵리듀스 스타일 배치 처리 잡 형태. 
- 결정적 : 태스크가 여러 번 실행되도 동일한 결과를 보여줌. 중복 없는 일회 처리 보장 (exactly-once)
- 전통적 분산 스트림 처리(초 단위 이하 반응속도)보다 느림.
  - 대부분 스트리밍 처리가 이렇게 빠른 연산을 요구하지는 않는다.
  - 카프카와 결합하여 사용하면 지연을 낮출 수 있다.



## 정형화 스트리밍의 프로그래밍 모델

- 데이터 스트림에서 새로운 코드 = 무한 테이블에 추가되는 새로운 행

1. 입력 소스 지정

2. 데이터 변형

3. 출력 싱크와 모드 결정

   출력 모드 : 추가 모드, 전체 모드, 업데이트 모드

4. 세부 처리

   - 트리거링 상세 내용 : 새롭게 추가된 스트리밍 데이터를 발견하고 처리하는 동작이 언제 발동되는지 의미
     - 기본 default : 마이크로 배치가 완료되자마자 다음 마이크로 배치가 실행되는 곳부터 데이터 실행
     - 트리거 간격에 따른 처리 시간 processingTime
     - 일회 실행 once
     - 연속 continuous
   - 체크포인트 위치 : 진행중인 데이터 상황을 저장 할 수 있는 디렉터리

5. 쿼리 시작

   - start() : 논블로킹 함수. 백그라운드에서 쿼리를 실행하고 호출한 즉시 객체를 리턴한다.
   - 블로킹을 원하면 `awaitTermination()` 



## 실행 중인 스트리밍 쿼리의 내부

- 스파크 SQL 은 아래 루프를 백그라운드 스레드에서 반복적으로 실행한다.
  - 설정된 트리거 간격마다 스레드는 새 데이터가 있는지 스트리밍 원천을 확인
  - 새 데이터가 있으면 마이크로 배치로 실행. 논리, 실행 계획 생성되고 여기에 새 데이터를 소스에서 읽어 점진적으로 업데이트된 결과를 계산, 출력 모드에 따라 싱크에 쓴다.
- 정형화 스트리밍에서 데이터 실행은 스파크 SQL 을 사용한다. 따라서 엔진 최적화 실행이 가능하다.



## 동작중인 쿼리 모니터링하기

- `StreamingQuery.status()`
- `StreamingQueryListener` : SparkSession 위에서 동작하는 슽리밍 쿼리의 모든 이벤트에서 리스너의 메서드를 호출



## 스트리밍 데이터 소스와 싱크

- from 파일 : 디렉터리에 쓰여진 파일들을 하나의 데이터 스트림으로 간주할 수 있다.



## Streaming Join

- 정형화 스트리밍은 스트리밍 데이터세트와 다른 정적 or 스트리밍 데이터세트와 조인을 할 수 있게 해준다.
- 스트림-정적 데이터 조인
- 스트림-스트림 조인
  - 매칭되는 데이터의 순서, 지연 정도를 알 수 없다.
  - 따라서 양쪽의 스트리밍 상태로부터 입력 데이터를 버퍼링해서 지연 처리하고, 지속적으로 새로운 데이터가 도착할 때마다 매칭되는지 체크
  - 선택적 워터마킹을 사용한 내부 조인
    - 안정적 운영을 위해서는 필수
    - 워터마크 시간 이상 지연되면 정합성 보장 X



## 임의의 상태 정보 유지 연산

- `mapGroupWithState()`
  - K, V, S, U
- `flatMapGroupWithState()`
  - 위 메소드 단점 보완. 리턴타입이 이터레이터, 개수 관계 없음. 아무것도 리턴안할 수도 있음.



## 성능 튜닝

- 클러스터 자원 배치
- 셔플을 위한 파티션 수 조정
- 안정성을 위한 소스의 처리량 제한
- 동일 스파크 애플리케이션에서 다중 스트리밍 쿼리 실행



## kc-spark

- checkpointLoation 사용 X
  - 마이크로배치에서 오프셋 저장 지연 이슈.
  - write 지연이 적은 zookeeper 로 변경

